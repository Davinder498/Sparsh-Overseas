rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper Functions
    function isSignedIn() {
      return request.auth != null;
    }
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    function isNotary() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'NOTARY';
    }
    function isPensioner() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'PENSIONER';
    }
    
    // Users Collection
    match /users/{userId} {
      // Notary needs to see Pensioner names/roles for review
      allow read: if isSignedIn();
      // Users can manage their own profile
      allow create, update, delete: if isOwner(userId);
    }
    
    // Audit Logs Collection
    match /audit_logs/{logId} {
      // Blind write: allow creation if there is a userId provided in the data.
      // We do not allow read/update/delete to ensure the integrity of the audit trail.
      allow create: if request.resource.data.userId != null;
      allow read, update, delete: if false; 
    }
    
    // Applications Collection
    match /applications/{appId} {
      allow read: if isSignedIn() && (isOwner(resource.data.pensionerId) || isNotary());
      
      allow create: if (
        isPensioner() && isOwner(request.resource.data.pensionerId)
        // Strict Schema Validation
        && request.resource.data.pensionerName is string && request.resource.data.pensionerName.size() > 0
        && request.resource.data.ppoNumber is string && request.resource.data.ppoNumber.size() > 0
        && request.resource.data.dateOfBirth.matches('^[0-9]{4}-[0-9]{2}-[0-9]{2}$')
        && request.resource.data.status == 'SUBMITTED'
      );
      
      allow update: if (
        // Case 1: Notary Attestation/Rejection
        ( isNotary() 
          && resource.data.status == 'SUBMITTED'
          && (request.resource.data.status == 'ATTESTED' || request.resource.data.status == 'REJECTED')
          && request.resource.data.diff(resource.data).affectedKeys().hasOnly([
              'status', 'notaryId', 'notaryName', 'notarySignature',
              'attestationDate', 'rejectionReason', 'history'
            ])
        ) 
        ||
        // Case 2: Pensioner final transmission to SPARSH
        ( isPensioner() 
          && isOwner(resource.data.pensionerId) 
          && resource.data.status == 'ATTESTED'
          && request.resource.data.status == 'SENT_TO_SPARSH'
          && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'history'])
        )
      );
    }
  }
}